{% include calculate_relative_base.html %}
{% include escape-404.html %}

<!-- JS -->
{% if page.layout == "post" %}
  <!-- Mailchimp linking -->
  <script id="mcjs">!function(c,h,i,m,p){m=c.createElement(h),p=c.getElementsByTagName(h)[0],m.async=1,m.src=i,p.parentNode.insertBefore(m,p)}(document,"script","https://chimpstatic.com/mcjs-connected/js/users/8ece198b3eb260e6838461a60/d20d9fb9aad962399025da52e.js");</script>
{% endif %}

{% if page.toc %}
  <script src="https://cdn.jsdelivr.net/gh/cferdinandi/gumshoe@5.1.1/dist/gumshoe.polyfills.min.js"></script>
{% endif %}

{% if page.mathjax %}
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "CommonHTML": { linebreaks: { automatic: true } }
    });
  </script>
  <script src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
{% endif %}

<script src="{{ relativeBase }}assets/js/jquery-3.2.1.min.js"></script>
<script src="{{ relativeBase }}assets/js/main.js"></script>
<script src="{{ relativeBase }}assets/js/jekyll-search.js"></script>
<script>
  SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('results-container'),
      json: '{{ relativeBase }}search.json',
      searchResultTemplate: '<li><a href="{url}" title="{description}">{title}</a></li>',
      noResultsText: 'No results found',
      fuzzy: false,
      exclude: ['Welcome']
    });
</script>

{% if page.url contains "ipfs-404" %}
  <script class="deep-dir">
    function fixPath() {
      var own_url = window.location.href;
      var countOfSlashes = (own_url.match(/\//g) || []).length;
      var minimumSlashes = 3;
      var i = 0;
      var replaceStr = "";
      if (own_url.includes("/ipfs/")) {
        minimumSlashes = 5;
      }
      if (countOfSlashes > minimumSlashes) {
        var relativeBase = "";
        for (i = minimumSlashes; i < countOfSlashes; i++){
          relativeBase = relativeBase + "../";
        }
        var elements = document.getElementsByTagName("link");
        for (i = 0; i < elements.length; i++) {
          replaceStr = elements[i].getAttribute("href");
          if ( replaceStr != null ) {
            replaceStr = replaceStr.replace(/\.\//g, relativeBase);
            elements[i].setAttribute("href", replaceStr);
          }
        }
        elements = document.getElementsByTagName("a");
        for (i = 0; i < elements.length; i++) {
          replaceStr = elements[i].getAttribute("href");
          if ( replaceStr != null ) {
            replaceStr = replaceStr.replace(/\.\//g, relativeBase);
            elements[i].setAttribute("href", replaceStr);
          }
          if (elements[i].style.background!=null) {
            elements[i].style.background = elements[i].style.background.replace("./", relativeBase);
          }
        }
        elements = document.getElementsByTagName("img");
        for (i = 0; i < elements.length; i++) {
          replaceStr = elements[i].getAttribute("src");
          if ( replaceStr != null ) {
            replaceStr = replaceStr.replace(/\.\//g, relativeBase);
            elements[i].setAttribute("src", replaceStr);
          }
        }
        elements = document.getElementsByTagName("source");
        for (i = 0; i < elements.length; i++) {
          replaceStr = elements[i].getAttribute("srcset");
          if ( replaceStr != null ) {
            replaceStr = replaceStr.replace(/\.\//g, relativeBase);
            elements[i].setAttribute("srcset", replaceStr);
          }
        }
        elements = document.getElementsByTagName("script");
        console.log(elements.length);
        for (i = 0; i < elements.length; i++) {
          console.log("checking: ", i);
          if (elements[i].className != "deep-dir") {
            replaceStr = elements[i].getAttribute("src");
            if (replaceStr!=null) {
              if (replaceStr.includes("./")){
                replaceStr = replaceStr.replace(/\.\//g, relativeBase);
                let new_script = document.createElement("script");
                new_script.setAttribute("src", replaceStr);
                document.head.appendChild(new_script);
                console.log("replaced src in: ", i, " with ", replaceStr);
              }
            } else {
              if (elements[i].innerText != null) {
                if (elements[i].innerText.includes("./")) {
                  let new_script2 = document.createElement("script");
                  new_script2.innerText = elements[i].innerText.replace("./", relativeBase);
                  console.log(i, " Inner TXT: ", new_script2.innerText);
                  document.head.appendChild(new_script2);
                }
              }
            }
          }
        }
      }
    }
    fixPath();
  </script>
{% endif %}